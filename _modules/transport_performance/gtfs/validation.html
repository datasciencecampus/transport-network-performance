<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>transport_performance.gtfs.validation &mdash; transport-performance 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=76ab003f" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            transport-performance
              <img src="../../../_static/dsc.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Explanation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../explanation/index.html">Explanation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html"><cite>transport-performance</cite> API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/coverage.html">Unit Test Coverage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to/index.html">How-to Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">transport-performance</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">transport_performance.gtfs.validation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for transport_performance.gtfs.validation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Validating GTFS data.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">gtfs_kit</span> <span class="k">as</span> <span class="nn">gk</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">plotly_io</span>
<span class="kn">from</span> <span class="nn">pretty_html_table</span> <span class="kn">import</span> <span class="n">build_table</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">plotly.graph_objects</span> <span class="kn">import</span> <span class="n">Figure</span> <span class="k">as</span> <span class="n">PlotlyFigure</span>

<span class="kn">from</span> <span class="nn">transport_performance.gtfs.validators</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">validate_travel_over_multiple_stops</span><span class="p">,</span>
    <span class="n">validate_travel_between_consecutive_stops</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">transport_performance.gtfs.cleaners</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">clean_consecutive_stop_fast_travel_warnings</span><span class="p">,</span>
    <span class="n">clean_multiple_stop_fast_travel_warnings</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">transport_performance.gtfs.routes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">scrape_route_type_lookup</span><span class="p">,</span>
    <span class="n">get_saved_route_type_lookup</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">transport_performance.utils.defence</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_is_expected_filetype</span><span class="p">,</span>
    <span class="n">_check_namespace_export</span><span class="p">,</span>
    <span class="n">_check_parent_dir_exists</span><span class="p">,</span>
    <span class="n">_check_column_in_df</span><span class="p">,</span>
    <span class="n">_type_defence</span><span class="p">,</span>
    <span class="n">_check_item_in_iter</span><span class="p">,</span>
    <span class="n">_check_attribute</span><span class="p">,</span>
    <span class="n">_enforce_file_extension</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">transport_performance.gtfs.report.report_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TemplateHTML</span><span class="p">,</span>
    <span class="n">_set_up_report_dir</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">transport_performance.utils.constants</span> <span class="kn">import</span> <span class="n">PKG_PATH</span>


<span class="k">def</span> <span class="nf">_get_intermediate_dates</span><span class="p">(</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of daily timestamps between two dates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : pd.Timestamp</span>
<span class="sd">        The start date of the given time period in %Y%m%d format.</span>
<span class="sd">    end : pd.Timestamp</span>
<span class="sd">        The end date of the given time period in %Y%m%d format.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[pd.Timestamp]</span>
<span class="sd">        A list of daily timestamps for each day in the time period</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If `start` or `end` are not of type pd.Timestamp.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># checks for start and end</span>
    <span class="n">_type_defence</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span>
    <span class="n">_type_defence</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_create_map_title_text</span><span class="p">(</span>
    <span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">geom_crs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate the map title text when plotting convex hull.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gdf :  gpd.GeoDataFrame</span>
<span class="sd">        GeoDataFrame containing the spatial features.</span>
<span class="sd">    units :  str</span>
<span class="sd">        Distance units of the GTFS feed from which `gdf` originated.</span>
<span class="sd">    geom_crs : Union[str, int]:</span>
<span class="sd">        The geometric crs to use in reprojecting the data in order to</span>
<span class="sd">        calculate the area of the hull polygon.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The formatted text string for presentation in the map title.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `crs_unit` is not either &quot;kilometre&quot; or &quot;metre&quot;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;km&quot;</span><span class="p">]:</span>
        <span class="n">converted_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">geom_crs</span><span class="p">)</span>
        <span class="n">hull_area</span> <span class="o">=</span> <span class="n">converted_gdf</span><span class="o">.</span><span class="n">area</span>
        <span class="n">crs_unit</span> <span class="o">=</span> <span class="n">converted_gdf</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit_name</span>
        <span class="k">if</span> <span class="n">crs_unit</span> <span class="o">==</span> <span class="s2">&quot;metre&quot;</span><span class="p">:</span>
            <span class="n">hull_area</span> <span class="o">=</span> <span class="n">hull_area</span> <span class="o">/</span> <span class="mi">1000000</span>
        <span class="k">if</span> <span class="n">crs_unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kilometre&quot;</span><span class="p">,</span> <span class="s2">&quot;metre&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;CRS units for convex hull not recognised. &quot;</span>
                <span class="s2">&quot;Recognised units include: [&#39;metre&#39;, &#39;kilometre&#39;]. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; Found &#39;</span><span class="si">{</span><span class="n">crs_unit</span><span class="si">}</span><span class="s2">.&#39;&quot;</span>
            <span class="p">)</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="s2">&quot;GTFS Stops Convex Hull Area: &quot;</span>
        <span class="n">post</span> <span class="o">=</span> <span class="s2">&quot; nearest km&lt;sup&gt;2&lt;/sup&gt;.&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}{</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">hull_area</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="si">:</span><span class="s2">,</span><span class="si">}{</span><span class="n">post</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;GTFS Stops Convex Hull. Area Calculation for Metric &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Units Only. Units Found are in </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">txt</span>


<span class="k">def</span> <span class="nf">_convert_multi_index_to_single</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a dataframes index from MultiIndex to a singular index.</span>

<span class="sd">    This function also removes any differing names generated from numpy</span>
<span class="sd">    function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Pandas dataframe to adjust index (columns) of.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Pandas dataframe with a modified index (columns)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
    <span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">column</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;amin&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;amax&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span>


<div class="viewcode-block" id="GtfsInstance">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance">[docs]</a>
<span class="k">class</span> <span class="nc">GtfsInstance</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a feed instance for validation, cleaning &amp; visualisation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gtfs_pth : Union[str, bytes, os.PathLike]</span>
<span class="sd">        File path to GTFS archive.</span>
<span class="sd">    units: str, optionl</span>
<span class="sd">        Spatial units of the GTFS file, defaults to &quot;km&quot;.</span>
<span class="sd">    route_lookup_pth : Union[str, pathlib.Path], optional</span>
<span class="sd">        The path to the route type lookup. If left empty, the default path will</span>
<span class="sd">        be used. The default path points to a route lookup table that is held</span>
<span class="sd">        within this package, defaults to None.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    feed : gtfs_kit.Feed</span>
<span class="sd">        A gtfs_kit feed produced using the files at `gtfs_pth` on init.</span>
<span class="sd">    gtfs_path : Union[str, pathlib.Path]</span>
<span class="sd">        The path to the GTFS archive.</span>
<span class="sd">    file_list: list</span>
<span class="sd">        Files in the GTFS archive.</span>
<span class="sd">    validity_df: pd.DataFrame</span>
<span class="sd">        Table of GTFS errors, warnings &amp; their descriptions.</span>
<span class="sd">    dated_trip_counts: pd.DataFrame</span>
<span class="sd">        Dated trip counts by modality.</span>
<span class="sd">    daily_trip_summary: pd.DataFrame</span>
<span class="sd">        Summarized trip results by day of the week and modality.</span>
<span class="sd">    daily_route_summary: pd.DataFrame</span>
<span class="sd">        Dated route counts by modality.</span>
<span class="sd">    route_mode_summary_df: pd.DataFrame</span>
<span class="sd">        Summarized route counts by day of the week and modality.</span>
<span class="sd">    pre_processed_trips: pd.DataFrame</span>
<span class="sd">        A table of pre-processed trip data.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_gtfs_files()</span>
<span class="sd">        Returns the `file_list` attribute.</span>
<span class="sd">    is_valid()</span>
<span class="sd">        Returns the `validity_df` attribute.</span>
<span class="sd">    print_alerts()</span>
<span class="sd">        Print validity errors &amp; warning messages in full.</span>
<span class="sd">    clean_feed()</span>
<span class="sd">        Attempt to clean the `feed` attribute using `gtfs_kit`.</span>
<span class="sd">    viz_stops()</span>
<span class="sd">        Visualise the stops on a map as points or convex hull. Writes file.</span>
<span class="sd">    get_route_modes()</span>
<span class="sd">        Returns the `route_mode_summary_df` attribute.</span>
<span class="sd">    summarise_trips()</span>
<span class="sd">        Returns the `daily_trip_summary` attribute.</span>
<span class="sd">    summarise_routes()</span>
<span class="sd">        Returns the `daily_route_summary` attribute.</span>
<span class="sd">    html_report()</span>
<span class="sd">        Generate a HTML report describing the GTFS data.</span>
<span class="sd">    _produce_stops_map()</span>
<span class="sd">        Produces the stops map for use in `viz_stops()`.</span>
<span class="sd">    _order_dataframe_by_day()</span>
<span class="sd">        Orders tables by day. Used in `summarise_trips()` and</span>
<span class="sd">        `summarise_routes()`.</span>
<span class="sd">    _preprocess_trips_and_routes()</span>
<span class="sd">        Produces a table of dated trips for use in `_get_pre_processed_trips()`</span>
<span class="sd">        .</span>
<span class="sd">    _get_pre_processed_trips()</span>
<span class="sd">        Attempts to access the `pre_processed_trips` attribute and instantiates</span>
<span class="sd">        it with `_preprocess_trips_and_routes()` if not found.</span>
<span class="sd">    _summary_defence()</span>
<span class="sd">        Check the summary parameters for `summarise_trips()` and</span>
<span class="sd">        `summarise_routes()`</span>
<span class="sd">    _plot_summary()</span>
<span class="sd">        Save a plotly summary table, used in `html_report()`.</span>
<span class="sd">    _create_extended_repeated_pair_table()</span>
<span class="sd">        Return a table of repeated pair warnings. Used in</span>
<span class="sd">        `_extended_validation()`.</span>
<span class="sd">    _extended_validation()</span>
<span class="sd">        Generate HTML warning &amp; error summary tables for use in `html_report()`</span>
<span class="sd">        .</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        `pth` is not either of string or pathlib.Path.</span>
<span class="sd">    TypeError</span>
<span class="sd">        `units` is not of type str.</span>
<span class="sd">    FileExistsError</span>
<span class="sd">        `pth` does not exist on disk.</span>
<span class="sd">    ValueError</span>
<span class="sd">        `pth` does not have the expected file extension(s).</span>
<span class="sd">    ValueError</span>
<span class="sd">        `units` are not one of: &quot;m&quot;, &quot;km&quot;, &quot;metres&quot;, &quot;meters&quot;, &quot;kilometres&quot;,</span>
<span class="sd">        &quot;kilometers&quot;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gtfs_pth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
        <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;km&quot;</span><span class="p">,</span>
        <span class="n">route_lookup_pth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">_is_expected_filetype</span><span class="p">(</span><span class="n">pth</span><span class="o">=</span><span class="n">gtfs_pth</span><span class="p">,</span> <span class="n">param_nm</span><span class="o">=</span><span class="s2">&quot;gtfs_pth&quot;</span><span class="p">)</span>

        <span class="c1"># validate units param</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;metres&quot;</span><span class="p">,</span> <span class="s2">&quot;meters&quot;</span><span class="p">]:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kilometers&quot;</span><span class="p">,</span> <span class="s2">&quot;kilometres&quot;</span><span class="p">]:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;km&quot;</span>
        <span class="n">accepted_units</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;km&quot;</span><span class="p">]</span>

        <span class="n">_check_item_in_iter</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">accepted_units</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span> <span class="o">=</span> <span class="n">gk</span><span class="o">.</span><span class="n">read_feed</span><span class="p">(</span><span class="n">gtfs_pth</span><span class="p">,</span> <span class="n">dist_units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gtfs_path</span> <span class="o">=</span> <span class="n">gtfs_pth</span>
        <span class="k">if</span> <span class="n">route_lookup_pth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_is_expected_filetype</span><span class="p">(</span>
                <span class="n">pth</span><span class="o">=</span><span class="n">route_lookup_pth</span><span class="p">,</span>
                <span class="n">exp_ext</span><span class="o">=</span><span class="s2">&quot;.pkl&quot;</span><span class="p">,</span>
                <span class="n">param_nm</span><span class="o">=</span><span class="s2">&quot;route_lookup_pth&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE_LKP</span> <span class="o">=</span> <span class="n">get_saved_route_type_lookup</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">route_lookup_pth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE_LKP</span> <span class="o">=</span> <span class="n">get_saved_route_type_lookup</span><span class="p">()</span>
        <span class="c1"># Constant to remove non needed columns from repeated</span>
        <span class="c1"># pair error information.</span>
        <span class="c1"># This is a messy method however it is the only</span>
        <span class="c1"># way to ensure that the error report remains</span>
        <span class="c1"># dynamic and can adadpt to different tables</span>
        <span class="c1"># in the GTFS file.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GTFS_UNNEEDED_COLUMNS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;routes&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;agency&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;agency_phone&quot;</span><span class="p">,</span> <span class="s2">&quot;agency_lang&quot;</span><span class="p">],</span>
            <span class="s2">&quot;stop_times&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;stop_headsign&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pickup_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;drop_off_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;shape_dist_traveled&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timepoint&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;stops&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;wheelchair_boarding&quot;</span><span class="p">,</span>
                <span class="s2">&quot;location_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parent_station&quot;</span><span class="p">,</span>
                <span class="s2">&quot;platform_code&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;calendar_dates&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;calendar&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;trips&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;trip_headsign&quot;</span><span class="p">,</span>
                <span class="s2">&quot;block_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;shape_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;wheelchair_accessible&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;shapes&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

<div class="viewcode-block" id="GtfsInstance.get_gtfs_files">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.get_gtfs_files">[docs]</a>
    <span class="k">def</span> <span class="nf">get_gtfs_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of files making up the GTFS file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of files that create the GTFS file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gtfs_path</span><span class="p">)</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="n">file_list</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span></div>


<div class="viewcode-block" id="GtfsInstance.is_valid">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.is_valid">[docs]</a>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">far_stops</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check a feed is valid with `gtfs_kit`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        far_stops : bool, optional</span>
<span class="sd">            Whether or not to perform validation for far stops (both</span>
<span class="sd">            between consecutive stops and over multiple stops)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.core.frame.DataFrame</span>
<span class="sd">            Table of errors, warnings &amp; their descriptions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">far_stops</span><span class="p">:</span>
            <span class="n">validate_travel_between_consecutive_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">validate_travel_over_multiple_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity_df</span></div>


<div class="viewcode-block" id="GtfsInstance.print_alerts">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.print_alerts">[docs]</a>
    <span class="k">def</span> <span class="nf">print_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print validity errors &amp; warning messages in full.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alert_type : str, optional</span>
<span class="sd">                The alert type to print messages. Also accepts &quot;warning&quot;.</span>
<span class="sd">                Defaults to &quot;error&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            No `validity_df()` attrubute was found.</span>
<span class="sd">        UserWarning</span>
<span class="sd">            No alerts of the specified `alert_type` were found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_attr_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;`self.validity_df` is None, did you forget to use&quot;</span>
            <span class="s2">&quot; `self.is_valid()`?&quot;</span>
        <span class="p">)</span>
        <span class="n">_check_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;validity_df&quot;</span><span class="p">,</span> <span class="n">missing_attr_msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># In cases where no alerts of alert_type are found, KeyError raised</span>
            <span class="n">msgs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validity_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">alert_type</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># multiple errors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="c1"># case where single error</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No alerts of type </span><span class="si">{</span><span class="n">alert_type</span><span class="si">}</span><span class="s2"> were found.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="GtfsInstance.clean_feed">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.clean_feed">[docs]</a>
    <span class="k">def</span> <span class="nf">clean_feed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fast_travel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to clean feed using `gtfs_kit`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        validate: bool, optional</span>
<span class="sd">            Whether or not to validate the dataframe before cleaning</span>
<span class="sd">        fast_travel: bool, optional</span>
<span class="sd">            Whether or not to clean warnings related to fast travel.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">fast_travel</span><span class="p">,</span> <span class="s2">&quot;fast_travel&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">validate</span><span class="p">,</span> <span class="s2">&quot;valiidate&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">far_stops</span><span class="o">=</span><span class="n">fast_travel</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># In cases where shape_id is missing, keyerror is raised.</span>
            <span class="c1"># https://developers.google.com/transit/gtfs/reference#shapestxt</span>
            <span class="c1"># shows that shapes.txt is optional file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fast_travel</span><span class="p">:</span>
                <span class="n">clean_consecutive_stop_fast_travel_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">clean_multiple_stop_fast_travel_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># TODO: Issue 74 - Improve this to clean feed when KeyError raised</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KeyError. Feed was not cleaned.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_produce_stops_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">what_geoms</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_filtered</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">crs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">folium</span><span class="o">.</span><span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Avoiding complexity hook. Returns the required map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        what_geoms : str</span>
<span class="sd">            Has the user asked to visualise &#39;hull&#39; or &#39;points&#39;?</span>
<span class="sd">        is_filtered : bool</span>
<span class="sd">            Has the user specified to plot IDs in stops or stop_times only?</span>
<span class="sd">        crs : Union[int, str]</span>
<span class="sd">            The crs to use for hull calculation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        folium.folium.Map</span>
<span class="sd">            Folium map object, either points or convex hull.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">what_geoms</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_filtered</span><span class="p">:</span>
                <span class="n">plot_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">stop_times</span><span class="p">[</span><span class="s2">&quot;stop_id&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">stops</span><span class="p">[</span><span class="s2">&quot;stop_id&quot;</span><span class="p">]</span>
            <span class="c1"># viz stop locations</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">map_stops</span><span class="p">(</span><span class="n">plot_ids</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">what_geoms</span> <span class="o">==</span> <span class="s2">&quot;hull&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_filtered</span><span class="p">:</span>
                <span class="c1"># filter the stops table to only those stop_ids present</span>
                <span class="c1"># in stop_times, this ensures hull viz agrees with point viz</span>
                <span class="n">stop_time_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">stop_times</span><span class="p">[</span><span class="s2">&quot;stop_id&quot;</span><span class="p">])</span>
                <span class="n">gtfs_hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">compute_convex_hull</span><span class="p">(</span>
                    <span class="n">stop_ids</span><span class="o">=</span><span class="n">stop_time_ids</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if not filtering, use gtfs_kit method</span>
                <span class="n">gtfs_hull</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">compute_convex_hull</span><span class="p">()</span>
            <span class="c1"># visualise feed, output to file with area est, based on stops</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">gtfs_hull</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;epsg:4326&quot;</span>
            <span class="p">)</span>
            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">dist_units</span>
            <span class="c1"># prepare the map title</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">_create_map_title_text</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">crs</span><span class="p">)</span>
            <span class="n">title_pre</span> <span class="o">=</span> <span class="s2">&quot;&lt;h3 align=&#39;center&#39; style=&#39;font-size:16px&#39;&gt;&lt;b&gt;&quot;</span>
            <span class="n">title_html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title_pre</span><span class="si">}{</span><span class="n">txt</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;/h3&gt;&quot;</span>
            <span class="n">geo_j</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">geo_j</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">geo_j</span><span class="p">,</span> <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fillColor&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">()</span>
            <span class="n">geo_j</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">get_root</span><span class="p">()</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">folium</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">title_html</span><span class="p">))</span>
            <span class="c1"># format map zoom and center</span>
            <span class="n">m</span><span class="o">.</span><span class="n">fit_bounds</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get_bounds</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">m</span>

<div class="viewcode-block" id="GtfsInstance.viz_stops">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.viz_stops">[docs]</a>
    <span class="k">def</span> <span class="nf">viz_stops</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">out_pth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span>
        <span class="n">geoms</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span><span class="p">,</span>
        <span class="n">geom_crs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">27700</span><span class="p">,</span>
        <span class="n">create_out_parent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">filtered_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualise the stops on a map as points or convex hull. Writes file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_pth : Union[str, pathlib.Path]</span>
<span class="sd">            Path to write the map file html document to, including the file</span>
<span class="sd">            name. Must end with &#39;.html&#39; file extension.</span>
<span class="sd">        geoms : str, optional</span>
<span class="sd">            Type of map to plot. If `geoms=point` (the default) uses `gtfs_kit`</span>
<span class="sd">            to map point locations of available stops. If `geoms=hull`,</span>
<span class="sd">            calculates the convex hull &amp; its area, defaults to &quot;point&quot;.</span>
<span class="sd">        geom_crs : Union[str, int], optional</span>
<span class="sd">            Geometric CRS to use for the calculation of the convex hull area</span>
<span class="sd">            only, defaults to &quot;27700&quot; (OSGB36, British National Grid).</span>
<span class="sd">        create_out_parent : bool, optional</span>
<span class="sd">            Should the parent directory of `out_pth` be created if not found,</span>
<span class="sd">            defaults to False.</span>
<span class="sd">        filtered_only: bool, optional</span>
<span class="sd">            When True, only stops referenced within stop_times.txt will be</span>
<span class="sd">            plotted. When False, stops referenced in stops.txt will be plotted.</span>
<span class="sd">            Note that gtfs_kit filtering behaviour removes stops from</span>
<span class="sd">            stop_times.txt but not stops.txt, defaults to True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            `out_pth` is not either of string or pathlib.PosixPath.</span>
<span class="sd">            `geoms` is not of type str</span>
<span class="sd">            `geom_crs` is not of type str or int</span>
<span class="sd">            `create_out_parent` or `filtered_only` are not of type bool</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            Raised if the parent directory of `out_pth` could not be found on</span>
<span class="sd">            disk and `create_out_parent` is False.</span>
<span class="sd">        KeyError</span>
<span class="sd">            The stops table has no &#39;stops_code&#39; column.</span>
<span class="sd">        UserWarning</span>
<span class="sd">            If the file extension of `out_pth` is not .html, the extension will</span>
<span class="sd">            be changed to .html.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typing_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;out_pth&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">out_pth</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)],</span>
            <span class="s2">&quot;geoms&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">geoms</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="s2">&quot;geoms_crs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">geom_crs</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;create_out_parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">create_out_parent</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
            <span class="s2">&quot;filtered_only&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">filtered_only</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">typing_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_type_defence</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_nm</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># out_pth defence</span>
        <span class="n">_check_parent_dir_exists</span><span class="p">(</span>
            <span class="n">pth</span><span class="o">=</span><span class="n">out_pth</span><span class="p">,</span> <span class="n">param_nm</span><span class="o">=</span><span class="s2">&quot;out_pth&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="n">create_out_parent</span>
        <span class="p">)</span>
        <span class="n">out_pth</span> <span class="o">=</span> <span class="n">_enforce_file_extension</span><span class="p">(</span><span class="n">out_pth</span><span class="p">,</span> <span class="s2">&quot;.html&quot;</span><span class="p">,</span> <span class="s2">&quot;.html&quot;</span><span class="p">,</span> <span class="s2">&quot;out_pth&quot;</span><span class="p">)</span>

        <span class="c1"># geoms defence</span>
        <span class="n">geoms</span> <span class="o">=</span> <span class="n">geoms</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ACCEPT_VALS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="s2">&quot;hull&quot;</span><span class="p">]</span>
        <span class="n">_check_item_in_iter</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">ACCEPT_VALS</span><span class="p">,</span> <span class="s2">&quot;geoms&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_produce_stops_map</span><span class="p">(</span>
                <span class="n">what_geoms</span><span class="o">=</span><span class="n">geoms</span><span class="p">,</span> <span class="n">is_filtered</span><span class="o">=</span><span class="n">filtered_only</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">geom_crs</span>
            <span class="p">)</span>
            <span class="c1"># map_stops will fail if stop_code not present. According to :</span>
            <span class="c1"># https://developers.google.com/transit/gtfs/reference#stopstxt</span>
            <span class="c1"># This should be an optional column</span>
            <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_pth</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># KeyError inside of an except KeyError here. This is to provide</span>
            <span class="c1"># a more detailed error message on why a KeyError is being raised.</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s2">&quot;The stops table has no &#39;stop_code&#39; column. While &quot;</span>
                <span class="s2">&quot;this is an optional field in a GTFS file, it &quot;</span>
                <span class="s2">&quot;raises an error through the gtfs-kit package.&quot;</span>
            <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_order_dataframe_by_day</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">day_column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;day&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Order a dataframe by days of the week in real-world order.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Input dataframe containing a column with the name</span>
<span class="sd">            of the day of a record</span>
<span class="sd">        day_column_name : str, optional</span>
<span class="sd">            The name of the columns in the pandas dataframe</span>
<span class="sd">            that contains the name of the day of a record,</span>
<span class="sd">            by default &quot;day&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The inputted dataframe ordered by the day column</span>
<span class="sd">            (by real world order).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            `df` is not of type pd.DataFrame.</span>
<span class="sd">            `day_column_name` is not of type str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># defences for parameters</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">day_column_name</span><span class="p">,</span> <span class="s2">&quot;day_column_name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="c1"># hard coded day order</span>
        <span class="n">day_order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;monday&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;tuesday&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;wednesday&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;thursday&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;friday&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;saturday&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;sunday&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># apply the day order and sort the df</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">day_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">day_order</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;day_order&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;day_order&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_preprocess_trips_and_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a trips table containing a record for each trip on each date.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A dataframe containing a record of every trip on every day</span>
<span class="sd">            from the gtfs feed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a calendar lookup (one row = one date, rather than date range)</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># convert dates to dt and create a list of dates between them</span>
        <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">],</span> <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calendar</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_get_intermediate_dates</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># explode the dataframe into daily rows for each service</span>
        <span class="c1">#  (between the given time period)</span>
        <span class="n">full_calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
        <span class="n">calendar</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">,</span> <span class="s2">&quot;end_date&quot;</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># obtain the day of a given date</span>
        <span class="n">full_calendar</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_calendar</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
        <span class="n">full_calendar</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_calendar</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">day</span><span class="p">:</span> <span class="n">day</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># reformat the data into a long format and only keep dates</span>
        <span class="c1"># where the service is active.</span>
        <span class="c1"># this ensures that dates are only kept when the service</span>
        <span class="c1"># is running (e.g., Friday)</span>
        <span class="n">melted_calendar</span> <span class="o">=</span> <span class="n">full_calendar</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;service_id&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;valid_day&quot;</span>
        <span class="p">)</span>
        <span class="n">melted_calendar</span> <span class="o">=</span> <span class="n">melted_calendar</span><span class="p">[</span><span class="n">melted_calendar</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">melted_calendar</span> <span class="o">=</span> <span class="n">melted_calendar</span><span class="p">[</span>
            <span class="n">melted_calendar</span><span class="p">[</span><span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">melted_calendar</span><span class="p">[</span><span class="s2">&quot;valid_day&quot;</span><span class="p">]</span>
        <span class="p">][[</span><span class="s2">&quot;service_id&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]]</span>

        <span class="c1"># join the dates to the trip information to then join on the</span>
        <span class="c1"># route_type from the route table</span>
        <span class="n">trips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">get_trips</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">get_routes</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dated_trips</span> <span class="o">=</span> <span class="n">trips</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">melted_calendar</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;service_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">dated_trips_routes</span> <span class="o">=</span> <span class="n">dated_trips</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">routes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;route_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">dated_trips_routes</span>

    <span class="k">def</span> <span class="nf">_get_pre_processed_trips</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain pre-processed trip data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            `pre_processed_trips` attribute.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_processed_trips</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_processed_trips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_trips_and_routes</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_processed_trips</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_summary_defence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">summ_ops</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">],</span>
        <span class="n">return_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for any invalid parameters in a summarising function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        summ_ops : list, optional</span>
<span class="sd">            A list of operators used to get a summary of a given day,</span>
<span class="sd">            by default [np.min, np.max, np.mean, np.median]</span>
<span class="sd">        return_summary : bool, optional</span>
<span class="sd">            When True, a summary is returned. When False, route data</span>
<span class="sd">            for each date is returned, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            `return_summary` is not of type pd.df.</span>
<span class="sd">            `summ_ops` must be a numpy function or a list.</span>
<span class="sd">            Each item in a `summ_ops` list must be a function.</span>
<span class="sd">            Each item in a `summ_ops` list must be a numpy namespace export.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            `summ_ops` is a function not exported from numpy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return_summary defence</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">return_summary</span><span class="p">,</span> <span class="s2">&quot;return_summary&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># summ_ops defence</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summ_ops</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">summ_ops</span><span class="p">:</span>
                <span class="c1"># updated for numpy &gt;= 1.25.0, this check rules out cases</span>
                <span class="c1"># that are not functions</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;numpy&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_namespace_export</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">np</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">i</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="s2">&quot;Each item in `summ_ops` must be a numpy function.&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; Found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="s2">&quot;Each item in `summ_ops` must be a function.&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; Found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">summ_ops</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_namespace_export</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">np</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">summ_ops</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;`summ_ops` expects numpy functions only.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;`summ_ops` expects a numpy function or list of numpy&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; functions. Found </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">summ_ops</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="GtfsInstance.summarise_trips">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.summarise_trips">[docs]</a>
    <span class="k">def</span> <span class="nf">summarise_trips</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">summ_ops</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">],</span>
        <span class="n">return_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a summarised table of trip statistics by day of week.</span>

<span class="sd">        For trip count summaries, func counts distinct trip_id only. These</span>
<span class="sd">        are then summarised into average/median/min/max (default) number</span>
<span class="sd">        of trips per day. Raw data for each date can also be obtained by</span>
<span class="sd">        setting the &#39;return_summary&#39; parameter to False (bool).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        summ_ops : list, optional</span>
<span class="sd">            A list of operators used to get a summary of a given day,</span>
<span class="sd">            by default [np.min, np.max, np.mean, np.median].</span>
<span class="sd">        return_summary : bool, optional</span>
<span class="sd">            When True, a summary is returned. When False, trip data</span>
<span class="sd">            for each date is returned, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A dataframe containing either summarized results or dated trip</span>
<span class="sd">            data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            return_summary is not of type pd.df.</span>
<span class="sd">            summ_ops must be a numpy function or a list.</span>
<span class="sd">            Each item in a summ_ops list must be a function.</span>
<span class="sd">            Each item in a summ_ops list must be a numpy namespace export.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            summ_ops is a function not exported from numpy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_defence</span><span class="p">(</span><span class="n">summ_ops</span><span class="o">=</span><span class="n">summ_ops</span><span class="p">,</span> <span class="n">return_summary</span><span class="o">=</span><span class="n">return_summary</span><span class="p">)</span>
        <span class="n">pre_processed_trips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pre_processed_trips</span><span class="p">()</span>

        <span class="c1"># clean the trips to ensure that there are no duplicates</span>
        <span class="n">cleaned_trips</span> <span class="o">=</span> <span class="n">pre_processed_trips</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;trip_id&quot;</span><span class="p">,</span> <span class="s2">&quot;route_type&quot;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">trip_counts</span> <span class="o">=</span> <span class="n">cleaned_trips</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;route_type&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;trip_id&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">trip_counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trip_counts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">mapper</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;trip_id&quot;</span><span class="p">:</span> <span class="s2">&quot;trip_count&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dated_trip_counts</span> <span class="o">=</span> <span class="n">trip_counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_summary</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dated_trip_counts</span>

        <span class="c1"># aggregate to mean/median/min/max (default) trips on each day</span>
        <span class="c1"># of the week</span>
        <span class="n">day_trip_counts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">trip_counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;route_type&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;trip_count&quot;</span><span class="p">:</span> <span class="n">summ_ops</span><span class="p">})</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># order the days (for plotting future purposes)</span>
        <span class="n">day_trip_counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_dataframe_by_day</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">day_trip_counts</span><span class="p">)</span>
        <span class="n">day_trip_counts</span> <span class="o">=</span> <span class="n">day_trip_counts</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">day_trip_counts</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reformat columns</span>
        <span class="c1"># including normalsing min and max between different</span>
        <span class="c1"># numpy versions (amin/min, amax/max)</span>
        <span class="n">day_trip_counts</span> <span class="o">=</span> <span class="n">_convert_multi_index_to_single</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">day_trip_counts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daily_trip_summary</span> <span class="o">=</span> <span class="n">day_trip_counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_trip_summary</span></div>


<div class="viewcode-block" id="GtfsInstance.summarise_routes">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.summarise_routes">[docs]</a>
    <span class="k">def</span> <span class="nf">summarise_routes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">summ_ops</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">],</span>
        <span class="n">return_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a summarised table of route statistics by day of week.</span>

<span class="sd">        For route count summaries, func counts route_id only, irrespective of</span>
<span class="sd">        which service_id the routes map to. If the services run on different</span>
<span class="sd">        calendar days, they will be counted separately. In cases where more</span>
<span class="sd">        than one service runs the same route on the same day, these will not be</span>
<span class="sd">        counted as distinct routes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        summ_ops : list, optional</span>
<span class="sd">            A list of operators used to get a summary of a given day,</span>
<span class="sd">            by default [np.min, np.max, np.mean, np.median].</span>
<span class="sd">        return_summary : bool, optional</span>
<span class="sd">            When True, a summary is returned. When False, route data</span>
<span class="sd">            for each date is returned, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A dataframe containing either summarized results or dated route</span>
<span class="sd">            data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            return_summary is not of type pd.df.</span>
<span class="sd">            summ_ops must be a numpy function or a list.</span>
<span class="sd">            Each item in a summ_ops list must be a function.</span>
<span class="sd">            Each item in a summ_ops list must be a numpy namespace export.</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            summ_ops is a function not exported from numpy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary_defence</span><span class="p">(</span><span class="n">summ_ops</span><span class="o">=</span><span class="n">summ_ops</span><span class="p">,</span> <span class="n">return_summary</span><span class="o">=</span><span class="n">return_summary</span><span class="p">)</span>
        <span class="n">pre_processed_trips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pre_processed_trips</span><span class="p">()</span>
        <span class="n">cleaned_routes</span> <span class="o">=</span> <span class="n">pre_processed_trips</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;route_id&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;route_type&quot;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="c1"># group data into route counts per day</span>
        <span class="n">route_count</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cleaned_routes</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;route_type&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;route_id&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">route_count</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">mapper</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;route_id&quot;</span><span class="p">:</span> <span class="s2">&quot;route_count&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dated_route_counts</span> <span class="o">=</span> <span class="n">route_count</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_summary</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dated_route_counts</span>

        <span class="c1"># aggregate the to the average number of routes</span>
        <span class="c1"># on a given day (e.g., Monday)</span>
        <span class="n">day_route_count</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">route_count</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="s2">&quot;route_type&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;route_count&quot;</span><span class="p">:</span> <span class="n">summ_ops</span><span class="p">})</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># order the days (for plotting future purposes)</span>
        <span class="n">day_route_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_dataframe_by_day</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">day_route_count</span><span class="p">)</span>
        <span class="n">day_route_count</span> <span class="o">=</span> <span class="n">day_route_count</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">day_route_count</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># reformat columns</span>
        <span class="c1"># including normalsing min and max between different</span>
        <span class="c1"># numpy versions (amin/min, amax/max)</span>
        <span class="n">day_route_count</span> <span class="o">=</span> <span class="n">_convert_multi_index_to_single</span><span class="p">(</span><span class="n">day_route_count</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daily_route_summary</span> <span class="o">=</span> <span class="n">day_route_count</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_route_summary</span></div>


<div class="viewcode-block" id="GtfsInstance.get_route_modes">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.get_route_modes">[docs]</a>
    <span class="k">def</span> <span class="nf">get_route_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summarise the available routes by their associated `route_type`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.core.frame.DataFrame</span>
<span class="sd">            Summary table of route counts by transport mode.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the available modalities</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="n">scrape_route_type_lookup</span><span class="p">()</span>
        <span class="n">gtfs_route_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="c1"># Get readable route_type descriptions</span>
        <span class="n">out_tab</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span>
            <span class="n">lookup</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">gtfs_route_types</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_tab</span><span class="p">[</span><span class="s2">&quot;n_routes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">out_tab</span><span class="p">[</span><span class="s2">&quot;prop_routes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route_mode_summary_df</span> <span class="o">=</span> <span class="n">out_tab</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route_mode_summary_df</span></div>


    <span class="k">def</span> <span class="nf">_plot_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">which</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;trip&quot;</span><span class="p">,</span>
        <span class="n">orientation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span>
        <span class="n">day_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;day&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plotly_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">return_html</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_html</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">save_image</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="s2">&quot;gtfs&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">img_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">PlotlyFigure</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot (and save) a summary table using plotly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target_column : str</span>
<span class="sd">            The name of the column contianing the</span>
<span class="sd">            target data (counts)</span>
<span class="sd">        which : str, optional</span>
<span class="sd">            Which summary to plot. Options include &#39;trip&#39; and &#39;route&#39;,</span>
<span class="sd">            by default &quot;trip&quot;</span>
<span class="sd">        orientation : str, optional</span>
<span class="sd">            The orientation of the bar plot (&quot;v&quot; or &quot;h&quot;),</span>
<span class="sd">            by default &quot;v&quot;</span>
<span class="sd">        day_column : str, optional</span>
<span class="sd">            The name of the column containing the day,</span>
<span class="sd">            by default &quot;day&quot;</span>
<span class="sd">        width : int, optional</span>
<span class="sd">            The width of the plot (in pixels), by default 2000</span>
<span class="sd">        height : int, optional</span>
<span class="sd">            The height of the plot (in pixels), by default 800</span>
<span class="sd">        xlabel : str, optional</span>
<span class="sd">            The label for the x axis. If left empty, the column name will be</span>
<span class="sd">            used, by default None</span>
<span class="sd">        ylabel : str, optional</span>
<span class="sd">            The label for the y axis. If left empty, the column name will be</span>
<span class="sd">            used, by default None</span>
<span class="sd">        plotly_kwargs : dict, optional</span>
<span class="sd">            Kwargs to pass to fig.update_layout() for additional plot</span>
<span class="sd">            customisation, by default {}</span>
<span class="sd">        return_html : bool, optional</span>
<span class="sd">            Whether or not to return a html string, by default False</span>
<span class="sd">        save_html : bool, optional</span>
<span class="sd">            Whether or not to save the plot as a html file, by default False</span>
<span class="sd">        save_image : bool, optional</span>
<span class="sd">            Whether or not to save the plot as a PNG, by default False</span>
<span class="sd">        out_dir : Union[pathlib.Path, str], optional</span>
<span class="sd">            The directory to save the plot into. If a file extension is added</span>
<span class="sd">            to this directory, it won&#39;t be cleaned. Whatever is passed as the</span>
<span class="sd">            out dir will be used as the parent directory of the save, leaving</span>
<span class="sd">            the responsibility on the user to specify the correct path., by</span>
<span class="sd">            default os.path.join(&quot;outputs&quot;, &quot;gtfs&quot;)</span>
<span class="sd">        img_type : str, optional</span>
<span class="sd">            The type of the image to be saved. E.g, .svg or .jpeg., by default</span>
<span class="sd">            &quot;png&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Union[PlotlyFigure, str]</span>
<span class="sd">            Returns either a HTML string or the plotly figure</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            An error is raised if orientation is not &#39;v&#39; or &#39;h&#39;.</span>
<span class="sd">        ValueError</span>
<span class="sd">            An error is raised if an invalid iamge type is passed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parameter type defences</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="s2">&quot;which&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">day_column</span><span class="p">,</span> <span class="s2">&quot;day_column&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">target_column</span><span class="p">,</span> <span class="s2">&quot;target_column&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">plotly_kwargs</span><span class="p">,</span> <span class="s2">&quot;plotly_kwargs&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">return_html</span><span class="p">,</span> <span class="s2">&quot;return_html&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="s2">&quot;xlabel&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">save_html</span><span class="p">,</span> <span class="s2">&quot;save_html&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">save_image</span><span class="p">,</span> <span class="s2">&quot;save_iamge&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">img_type</span><span class="p">,</span> <span class="s2">&quot;img_type&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="c1"># lower params</span>
        <span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">which</span> <span class="o">=</span> <span class="n">which</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># ensure &#39;which&#39; is valid</span>
        <span class="n">_check_item_in_iter</span><span class="p">(</span>
            <span class="n">item</span><span class="o">=</span><span class="n">which</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;trip&quot;</span><span class="p">,</span> <span class="s2">&quot;route&quot;</span><span class="p">],</span> <span class="n">param_nm</span><span class="o">=</span><span class="s2">&quot;which&quot;</span>
        <span class="p">)</span>

        <span class="n">raw_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="s2">&quot;summary_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">_%m_%Y-%H_%M_%S&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">_check_parent_dir_exists</span><span class="p">(</span><span class="n">raw_pth</span><span class="p">,</span> <span class="s2">&quot;save_pth&quot;</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># orientation input defences</span>
        <span class="n">_check_item_in_iter</span><span class="p">(</span>
            <span class="n">item</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span> <span class="n">iterable</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">],</span> <span class="n">param_nm</span><span class="o">=</span><span class="s2">&quot;orientation&quot;</span>
        <span class="p">)</span>

        <span class="c1"># assign the correct values depending on which breakdown has been</span>
        <span class="c1"># chosen</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;trip&quot;</span><span class="p">:</span>
            <span class="n">_check_attribute</span><span class="p">(</span>
                <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">attr</span><span class="o">=</span><span class="s2">&quot;daily_trip_summary&quot;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;The daily_trip_summary table could not be found.&quot;</span>
                    <span class="s2">&quot; Did you forget to call &#39;.summarise_trips()&#39; first?&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">summary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_trip_summary</span>
            <span class="n">target_column</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;trip_count_</span><span class="si">{</span><span class="n">target_column</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;trip_count&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_column</span>
                <span class="k">else</span> <span class="n">target_column</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;route&quot;</span><span class="p">:</span>
            <span class="n">_check_attribute</span><span class="p">(</span>
                <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">attr</span><span class="o">=</span><span class="s2">&quot;daily_route_summary&quot;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;The daily_route_summary table could not be found.&quot;</span>
                    <span class="s2">&quot; Did you forget to call &#39;.summarise_routes()&#39; first?&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">summary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_route_summary</span>
            <span class="n">target_column</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;route_count_</span><span class="si">{</span><span class="n">target_column</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;route_count&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_column</span>
                <span class="k">else</span> <span class="n">target_column</span>
            <span class="p">)</span>

        <span class="c1"># dataframe column defences</span>
        <span class="n">_check_column_in_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">summary_df</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="n">target_column</span><span class="p">)</span>
        <span class="n">_check_column_in_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">summary_df</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="n">day_column</span><span class="p">)</span>

        <span class="c1"># convert column type for better graph plotting, use desc</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
        <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE_LKP</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;route_type&quot;</span>
        <span class="p">)</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_df</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">xlabel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">xlabel</span>
            <span class="k">if</span> <span class="n">xlabel</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">target_column</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span> <span class="k">else</span> <span class="n">day_column</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ylabel</span>
            <span class="k">if</span> <span class="n">ylabel</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">target_column</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span> <span class="k">else</span> <span class="n">day_column</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># plot summary using plotly express</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">summary_df</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">day_column</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span> <span class="k">else</span> <span class="n">target_column</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">target_column</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span> <span class="k">else</span> <span class="n">day_column</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span>
            <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;group&quot;</span><span class="p">,</span>
            <span class="n">text_auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># format plotly figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">),</span>
                <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">showline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">linecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">),</span>
                <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">showline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">linecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">),</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
                <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Route Type&quot;</span><span class="p">,</span>
                <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                <span class="n">bordercolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">borderwidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># apply custom arguments if passed</span>
        <span class="k">if</span> <span class="n">plotly_kwargs</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="o">**</span><span class="n">plotly_kwargs</span><span class="p">)</span>

        <span class="c1"># save the plot if specified (with correct file type)</span>
        <span class="k">if</span> <span class="n">save_html</span><span class="p">:</span>
            <span class="n">plotly_io</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span>
                <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">raw_pth</span> <span class="o">+</span> <span class="s2">&quot;.html&quot;</span><span class="p">),</span>
                <span class="n">full_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">save_image</span><span class="p">:</span>
            <span class="n">valid_img_formats</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;png&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;jpg&quot;</span><span class="p">,</span>
                <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span>
                <span class="s2">&quot;webp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;svg&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">_enforce_file_extension</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                    <span class="n">raw_pth</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">img_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="n">exp_ext</span><span class="o">=</span><span class="n">valid_img_formats</span><span class="p">,</span>
                <span class="n">default_ext</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
                <span class="n">param_nm</span><span class="o">=</span><span class="s2">&quot;img_type&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">plotly_io</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span>
                <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_html</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plotly_io</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">full_html</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">_create_extended_repeated_pair_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">join_vars</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">original_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate an extended table for repeated pair warnings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table : pd.DataFrame</span>
<span class="sd">            The dataframe with the repeated pair warnings</span>
<span class="sd">        join_vars : Union[str, list]</span>
<span class="sd">            The variables that have repeated pairs</span>
<span class="sd">        original_rows : list[int]</span>
<span class="sd">            The original duplicate rows, contained in the GTFS validation table</span>
<span class="sd">            (rows column)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            An extended dataframe containing repeated pairs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">original_rows</span><span class="p">]</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">original_rows</span><span class="p">)]</span>
        <span class="n">joined_rows</span> <span class="o">=</span> <span class="n">error_table</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">remaining</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">join_vars</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_original&quot;</span><span class="p">,</span> <span class="s2">&quot;_duplicate&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">joined_rows</span>

    <span class="k">def</span> <span class="nf">_extended_validation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">],</span> <span class="n">scheme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;green_dark&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate HTML outputs of impacted rows from GTFS errors/warnings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_path : Union[str, pathlib.Path]</span>
<span class="sd">            The path to save the HTML output to</span>
<span class="sd">        scheme : str, optional</span>
<span class="sd">            Colour scheme from pretty_html_table, by default &quot;green_dark&quot;.</span>
<span class="sd">            Colour schemes can be found here:</span>
<span class="sd">            https://pypi.org/project/pretty-html-table/</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;agency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span>
            <span class="s2">&quot;routes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">routes</span><span class="p">,</span>
            <span class="s2">&quot;stop_times&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">stop_times</span><span class="p">,</span>
            <span class="s2">&quot;stops&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">stops</span><span class="p">,</span>
            <span class="s2">&quot;trips&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">trips</span><span class="p">,</span>
            <span class="s2">&quot;calendar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># determine which errors/warnings have rows that can be located</span>
        <span class="n">validation_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
        <span class="n">validation_table</span><span class="p">[</span><span class="s2">&quot;valid_row&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_table</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">ext_validation_table</span> <span class="o">=</span> <span class="n">validation_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span>
            <span class="n">validation_table</span><span class="p">[</span><span class="s2">&quot;valid_row&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="c1"># locate the impacted rows for each error</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">ext_validation_table</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">],</span>
            <span class="n">ext_validation_table</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">],</span>
            <span class="n">ext_validation_table</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span>
            <span class="n">ext_validation_table</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="c1"># create a more informative table for repeated pairs</span>
            <span class="k">if</span> <span class="s2">&quot;Repeated pair&quot;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                <span class="n">join_vars</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">col</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">GTFS_UNNEEDED_COLUMNS</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">join_vars</span>
                <span class="p">]</span>
                <span class="n">filtered_tbl</span> <span class="o">=</span> <span class="n">table_map</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">impacted_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_extended_repeated_pair_table</span><span class="p">(</span>
                    <span class="n">table</span><span class="o">=</span><span class="n">filtered_tbl</span><span class="p">,</span>
                    <span class="n">join_vars</span><span class="o">=</span><span class="n">join_vars</span><span class="p">,</span>
                    <span class="n">original_rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">base_columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">item</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered_tbl</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">join_vars</span>
                <span class="p">]</span>
                <span class="n">duplicate_counts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">base_columns</span><span class="p">:</span>
                    <span class="n">duplicate_counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">impacted_rows</span><span class="p">[</span>
                        <span class="n">impacted_rows</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_original&quot;</span><span class="p">]</span>
                        <span class="o">==</span> <span class="n">impacted_rows</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_duplicate&quot;</span><span class="p">]</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">impacted_rows</span> <span class="o">=</span> <span class="n">table_map</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span>

            <span class="c1"># create the html to display the impacted rows (clean possibly)</span>
            <span class="n">table_html</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;head&gt;</span>
<span class="s2">                &lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot;&gt;</span>
<span class="s2">            &lt;/head&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">            &lt;h1 style=&quot;font-family: &#39;Poppins&#39;, sans-serif;margin: 10px;&quot;&gt;</span>
<span class="s2">                &lt;a href=&quot;index.html&quot; style=&quot;color:grey;weight:bold;&quot;&gt;</span>
<span class="s2">                Back to Index&lt;/a&gt;&lt;hr&gt;</span>
<span class="s2">                Table: </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&lt;br&gt;Message: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&lt;br&gt;</span>
<span class="s2">                Type: &lt;span style=&quot;color:</span><span class="si">{</span><span class="s1">&#39;red&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">msg_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="w"> </span><span class="k">else</span>
<span class="w">                        </span><span class="s1">&#39;orange&#39;</span><span class="si">}</span><span class="s2">;font-family: &#39;Poppins&#39;, sans-serif;&quot;&gt;</span>
<span class="s2">                        </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2">&lt;/span&gt;</span>
<span class="s2">            &lt;/h1&gt;&quot;&quot;&quot;</span>

            <span class="c1"># Add additional information for repeated pairs</span>
            <span class="c1"># to the HTML report</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicate_counts</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">table_html</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">table_html</span>
                            <span class="o">+</span> <span class="s2">&quot;&quot;&quot;&lt;br&gt;&lt;div</span>
<span class="s2">                        style=&quot;margin:10px;&quot;&gt;</span>
<span class="s2">                        &lt;span style=&quot;font-weight:bold;font-size:large&quot;&gt;</span>
<span class="s2">                        Duplicate Counts&lt;/span&gt;&quot;&quot;&quot;</span>
                        <span class="p">)</span>
                    <span class="n">table_html</span> <span class="o">=</span> <span class="n">table_html</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    &lt;div style=&quot;display: block;&quot;&gt;</span>
<span class="s2">                            &lt;dd style=&quot;font-weight: bold;</span>
<span class="s2">                                margin-inline-start: 0;</span>
<span class="s2">                                display: inline-block;</span>
<span class="s2">                                min-width: 160px;&quot;&gt;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &lt;/dd&gt;</span>
<span class="s2">                            &lt;dt style=&quot;display: inline-block;&quot;&gt;</span>
<span class="s2">                            </span><span class="si">{</span><span class="n">duplicate_counts</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/dt&gt;</span>
<span class="s2">                    &lt;/div&gt;&quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="n">table_html</span> <span class="o">=</span> <span class="n">table_html</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># add a more detailed route_type decription</span>
            <span class="k">if</span> <span class="s2">&quot;route_type&quot;</span> <span class="ow">in</span> <span class="n">impacted_rows</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">impacted_rows</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impacted_rows</span><span class="p">[</span>
                    <span class="s2">&quot;route_type&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
                <span class="n">impacted_rows</span> <span class="o">=</span> <span class="n">impacted_rows</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ROUTE_LKP</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;route_type&quot;</span>
                <span class="p">)</span>
                <span class="n">impacted_rows</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impacted_rows</span><span class="p">[</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                    <span class="n">impacted_rows</span><span class="p">[</span><span class="s2">&quot;route_type&quot;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">table_html</span> <span class="o">=</span> <span class="n">table_html</span> <span class="o">+</span> <span class="n">build_table</span><span class="p">(</span>
                <span class="n">impacted_rows</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;10px&quot;</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">table_html</span> <span class="o">=</span> <span class="n">table_html</span> <span class="o">+</span> <span class="s2">&quot;&lt;/body&gt;&quot;</span>

            <span class="c1"># save the output</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/gtfs_report/</span><span class="si">{</span><span class="n">save_name</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table_html</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="GtfsInstance.html_report">
<a class="viewcode-back" href="../../../reference/_autosummary/transport_performance.gtfs.validation.GtfsInstance.html#transport_performance.gtfs.validation.GtfsInstance.html_report">[docs]</a>
    <span class="k">def</span> <span class="nf">html_report</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">report_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">summary_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">extended_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a HTML report describing the GTFS data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        report_dir : Union[str, pathlib.Path], optional</span>
<span class="sd">            The directory to save the report to, by default &quot;outputs&quot;</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            Whether or not to overwrite the existing report if it already</span>
<span class="sd">            exists in the report_dir, by default False</span>
<span class="sd">        summary_type : str, optional</span>
<span class="sd">            The type of summary to show on the summaries on the gtfs report, by</span>
<span class="sd">            default &quot;mean&quot;</span>
<span class="sd">        extended_validation : bool, optional</span>
<span class="sd">            Whether or not to create extended reports for gtfs validation</span>
<span class="sd">            errors/warnings.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            An error raised if the type of summary passed is invalid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">overwrite</span><span class="p">,</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">_type_defence</span><span class="p">(</span><span class="n">summary_type</span><span class="p">,</span> <span class="s2">&quot;summary_type&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">_set_up_report_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">report_dir</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="n">summary_type</span> <span class="o">=</span> <span class="n">summary_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">_check_item_in_iter</span><span class="p">(</span>
            <span class="n">summary_type</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">],</span> <span class="s2">&quot;summary_type&quot;</span>
        <span class="p">)</span>

        <span class="c1"># store todays date</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y&quot;</span><span class="p">)</span>

        <span class="c1"># feed evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_feed</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fast_travel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># re-validate to clean any newly raised errors/warnings</span>
        <span class="n">validation_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">far_stops</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create extended reports if requested</span>
        <span class="k">if</span> <span class="n">extended_validation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extended_validation</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">report_dir</span><span class="p">)</span>
            <span class="n">info_href</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">validation_dataframe</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                <span class="o">+</span> <span class="n">validation_dataframe</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="s2">&quot;.html&quot;</span>
            <span class="p">)</span>
            <span class="n">validation_dataframe</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;a href=&quot;</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;&gt; Further Info&lt;/a&gt;&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="s2">&quot;Unavailable&quot;</span>
                <span class="k">for</span> <span class="n">href</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">info_href</span><span class="p">,</span> <span class="n">validation_dataframe</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="n">eval_temp</span> <span class="o">=</span> <span class="n">TemplateHTML</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">PKG_PATH</span><span class="p">,</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;gtfs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;report&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;html_templates&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;evaluation_template.html&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;eval_placeholder_1&quot;</span><span class="p">,</span>
            <span class="n">build_table</span><span class="p">(</span>
                <span class="n">validation_dataframe</span><span class="p">,</span>
                <span class="s2">&quot;green_dark&quot;</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;10px&quot;</span><span class="p">,</span>
                <span class="n">escape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;eval_title_1&quot;</span><span class="p">,</span> <span class="s2">&quot;GTFS Feed Warnings and Errors&quot;</span><span class="p">)</span>

        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;eval_placeholder_2&quot;</span><span class="p">,</span>
            <span class="n">build_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span> <span class="s2">&quot;green_dark&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;10px&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;eval_title_2&quot;</span><span class="p">,</span> <span class="s2">&quot;GTFS Agency Information&quot;</span><span class="p">)</span>

        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;name_placeholder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">feed_info</span><span class="p">[</span><span class="s2">&quot;feed_publisher_name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;url_placeholder&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">feed_info</span><span class="p">[</span><span class="s2">&quot;feed_publisher_url&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">replace_multiple</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;lang_placeholder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">feed_info</span><span class="p">[</span><span class="s2">&quot;feed_lang&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;start_placeholder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">feed_info</span><span class="p">[</span><span class="s2">&quot;feed_start_date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;end_placeholder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">feed_info</span><span class="p">[</span><span class="s2">&quot;feed_end_date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;version_placeholder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">feed_info</span><span class="p">[</span><span class="s2">&quot;feed_version&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">count_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;agency_placeholder&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">count_lookup</span><span class="p">[</span><span class="s2">&quot;agencies&quot;</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;routes_placeholder&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_lookup</span><span class="p">[</span><span class="s2">&quot;num_routes&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;trips_placeholder&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_lookup</span><span class="p">[</span><span class="s2">&quot;num_trips&quot;</span><span class="p">]))</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;stops_placeholder&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_lookup</span><span class="p">[</span><span class="s2">&quot;num_stops&quot;</span><span class="p">]))</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;shapes_placeholder&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">count_lookup</span><span class="p">[</span><span class="s2">&quot;num_shapes&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_gtfs_files</span><span class="p">()</span>
        <span class="n">file_list_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">file_list_html</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">file_list_html</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    &lt;div&gt;</span>
<span class="s2">                        &lt;dd&gt;</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">. &lt;/dd&gt;</span>
<span class="s2">                        &lt;dt&gt;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&lt;/dt&gt;</span>
<span class="s2">                    &lt;/div&gt;&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;eval_placeholder_3&quot;</span><span class="p">,</span> <span class="n">file_list_html</span><span class="p">)</span>
        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;eval_title_3&quot;</span><span class="p">,</span> <span class="s2">&quot;GTFS Files Included&quot;</span><span class="p">)</span>

        <span class="n">eval_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="s2">/gtfs_report/index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">eval_f</span><span class="p">:</span>
            <span class="n">eval_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">eval_temp</span><span class="o">.</span><span class="n">_get_template</span><span class="p">())</span>

        <span class="c1"># stops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viz_stops</span><span class="p">(</span>
            <span class="n">out_pth</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="s2">/gtfs_report/stop_locations.html&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viz_stops</span><span class="p">(</span>
            <span class="n">out_pth</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="s2">/gtfs_report/convex_hull.html&quot;</span><span class="p">),</span>
            <span class="n">geoms</span><span class="o">=</span><span class="s2">&quot;hull&quot;</span><span class="p">,</span>
            <span class="n">geom_crs</span><span class="o">=</span><span class="mi">27700</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">stops_temp</span> <span class="o">=</span> <span class="n">TemplateHTML</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">PKG_PATH</span><span class="p">,</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;gtfs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;report&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;html_templates&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stops_template.html&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">stops_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;stops_placeholder_1&quot;</span><span class="p">,</span> <span class="s2">&quot;stop_locations.html&quot;</span><span class="p">)</span>
        <span class="n">stops_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;stops_placeholder_2&quot;</span><span class="p">,</span> <span class="s2">&quot;convex_hull.html&quot;</span><span class="p">)</span>
        <span class="n">stops_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;stops_title_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Stops from GTFS data&quot;</span><span class="p">)</span>
        <span class="n">stops_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;stops_title_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Convex Hull Generated from GTFS Data&quot;</span>
        <span class="p">)</span>
        <span class="n">stops_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="s2">/gtfs_report/stops.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">stops_f</span><span class="p">:</span>
            <span class="n">stops_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">stops_temp</span><span class="o">.</span><span class="n">_get_template</span><span class="p">())</span>

        <span class="c1"># summaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarise_routes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarise_trips</span><span class="p">()</span>
        <span class="n">route_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_summary</span><span class="p">(</span>
            <span class="n">which</span><span class="o">=</span><span class="s2">&quot;route&quot;</span><span class="p">,</span>
            <span class="n">target_column</span><span class="o">=</span><span class="n">summary_type</span><span class="p">,</span>
            <span class="n">return_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Route Count&quot;</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Day&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">trip_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_summary</span><span class="p">(</span>
            <span class="n">which</span><span class="o">=</span><span class="s2">&quot;trip&quot;</span><span class="p">,</span>
            <span class="n">target_column</span><span class="o">=</span><span class="n">summary_type</span><span class="p">,</span>
            <span class="n">return_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Trip Count&quot;</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Day&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">summ_temp</span> <span class="o">=</span> <span class="n">TemplateHTML</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">PKG_PATH</span><span class="p">,</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;gtfs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;report&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;html_templates&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;summary_template.html&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">summ_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;plotly_placeholder_1&quot;</span><span class="p">,</span> <span class="n">route_html</span><span class="p">)</span>
        <span class="n">summ_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;plotly_title_1&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Route Summary by Day and Route Type (</span><span class="si">{</span><span class="n">summary_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">summ_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;plotly_placeholder_2&quot;</span><span class="p">,</span> <span class="n">trip_html</span><span class="p">)</span>
        <span class="n">summ_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span>
            <span class="s2">&quot;plotly_title_2&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Trip Summary by Day and Route Type (</span><span class="si">{</span><span class="n">summary_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">summ_temp</span><span class="o">.</span><span class="n">_insert</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="s2">/gtfs_report/summaries.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">summ_f</span><span class="p">:</span>
            <span class="n">summ_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">summ_temp</span><span class="o">.</span><span class="n">_get_template</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GTFS Report Created at </span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;View your report here: </span><span class="si">{</span><span class="n">report_dir</span><span class="si">}</span><span class="s2">/gtfs_report&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, ONS Data Science Campus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  

    <br><br>

    <div>
        Checkout the
        <a href="https://github.com/datasciencecampus/transport-network-performance">
            codebase on GitHub.
        </a>
    </div>

    <br>

    <div>
        For more ONS Data Science Campus news see the
        <a href="https://datasciencecampus.ons.gov.uk/">
            Campus' website
        </a>
        and
        <a href="https://twitter.com/i/flow/login?redirect_after_login=%2FDataSciCampus">
            follow us on Twitter.
        </a>
    </div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>